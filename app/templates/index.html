{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Flasky{% endblock %}

{% block css_styles %}
<style type="text/css">
    .container{
       width: 99%;
    }
    .text{
        margin-right:1%;
        width:38%;
        overflow:auto;
        display:inline
    }
    .comment_text{
        width:20%;
        overflow:auto;
        display:inline
    }
    #text_lines{
        overflow: auto;
        height: 300px;
    }
    #uploadFile{
        display:none;
    }
    .btn-right-first{
        margin-left: 82%;
    }
    .btn-right{
        margin-left: 10px;
    }
    #uploadForm{
        margin-bottom: 5%;
    }
</style>
{% endblock %}

{% block page_content %}
<div id="uploadForm">
    <div class="h2 text-center" id="fileName"></div>
    <input id="uploadFile" type="file" name=file/>
    <button id="uploadBtn" class="btn btn-primary btn-right-first" type="button">上传</button>
    <button id="convertBtn" class="btn btn-primary btn-right" type="button">转换</button>
    <button id="exportBtn" class="btn btn-primary btn-right" type="button">导出</button>
</div>
<div id="edit_area" style=";margin-bottom:10px;">
    <textarea id="original_text" class="form-control text" rows="20">
    </textarea>
    <textarea id="vernacular_text" class="form-control text" rows="20">
    </textarea>
    <textarea id="comment" class="form-control comment_text " rows="20">
    </textarea>
</div>
<h3>生成表格</h3>
<div id="text_lines" >
     <table class="table table-striped table-condensed table-bordered table-hover">
        <thead>
            <tr>
                <td>id</td>
                <td>原文</td>
                <td>白话文</td>
                <td>注释</td>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

{% endblock %}

{% block subscripts %}
<script>
$(document).ready(function(){
  textAreaDataInit();
  textAreaScrollBind();
  textAreaChangeBind();
  uploadFile();
  uploadBtnBind();
  convertBtnBind();
});
function uploadFile(){
    $('#uploadFile').on("change", function(e){
        var name = e.currentTarget.files[0].name;
        $("#fileName").text(name);
        var formData = new FormData();
        formData.append('file', $('#uploadFile')[0].files[0]);
        $.ajax({
            url: "{{ url_for('main.upload') }}",
            type: 'POST',
            cache: false,
            data: formData,
            processData: false,
            contentType: false
        }).done(function(res) {
            var data = JSON.parse(res)
            if(data.success == 'true'){
                var origin = data.parts.origin;
                var vernacular = data.parts.vernacular;
                var comment = data.parts.comment;
                $("#original_text").val(origin);
                $("#vernacular_text").val(vernacular);
                $("#comment").val(comment);
                localStorageRefresh($("#fileName").text(),origin,vernacular,comment);
            } else {
                alert(data.message);
            }
        }).fail(function(res) {});
  });
}
function convertBtnBind(){
    $("#convertBtn").on("click", function(){
        $.ajax({
            url: "{{ url_for('main.convert') }}",
            type: 'POST',
            cache: false,
            dataType:'json',
            data: JSON.stringify({
                "original_text": $("#original_text").val(),
                "vernacular_text": $("#vernacular_text").val(),
                "comment": $("#comment").val()
            }),
            contentType: "application/json"
        }).done(function(res) {
            var data = res.formatData;
            $("#text_lines tbody").empty();
            for (idx in data){
                var tr = $("<tr></tr>");
                tr.append("<td>"+ idx +"</td>");
                tr.append("<td>"+ data[idx].original_text +"</td>");
                tr.append("<td>"+ data[idx].vernacular_text +"</td>");
                commentStr = "";
                for (cidx in data[idx].comment){
                    commentStr += data[idx].comment[cidx] + ";";
                }
                tr.append("<td>"+ commentStr +"</td>");
                $("#text_lines tbody").append(tr);
            }
        }).fail(function(res) {});

    });
}
function uploadBtnBind(){
  $("#uploadBtn").on('click', function(e){
        e.preventDefault();
        $('#uploadFile').trigger('click');
  });
}
function textAreaDataInit(){
    $("textarea").each(function(){
        var id = $(this).attr("id");
        if(id in localStorage){
            $(this).val(localStorage[`${id}`]);
        }else{
            localStorage.setItem(id,$(this).val());
        }
    });
    if("file_name" in localStorage){
        $("#fileName").html(localStorage.file_name);
    }
}
function textAreaScrollBind(){
//   function scrollByOriginal_text(id,current){
//        var elem = $(`#${id}`);
//        var maxHeight = elem[0].scrollHeight -elem.outerHeight();
//        elem.scrollTop(maxHeight*current);
//    }
//   $("#original_text").scroll(function() {
//        var height = $(this)[0].scrollHeight - $(this).outerHeight();
//        var current = $(this).scrollTop()/height;
//        scrollByOriginal_text("vernacular_text",current);
//        scrollByOriginal_text("comment",current);
//        scrollByOriginal_text("text_lines",current);
//  });
}

function textAreaChangeBind(){
    $("textarea").each(function(){
        $(this).on('input propertychange', function() {
            var id=$(this).attr("id");
            localStorage.setItem(id,$(this).val());
        });
    });
}
function localStorageRefresh(file_name,original_text,vernacular_text,comment){
    localStorage.setItem("file_name",file_name);
    localStorage.setItem("original_text",original_text);
    localStorage.setItem("vernacular_text",vernacular_text);
    localStorage.setItem("comment",comment);
}
</script>
{% endblock %}
